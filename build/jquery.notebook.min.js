!function(e,t,n){var o=function(){var e=function(e){return e&&"none"!=e?e.match(/(-?[0-9\.]+)/g):[1,0,0,1,0,0]},t=function(e){return e.css("-webkit-transform")||e.css("transform")||e.css("-moz-transform")||e.css("-o-transform")||e.css("-ms-transform")},n=function(n){var o=t(n);return e(o)},o=function(e,t){e.css("-webkit-transform",t),e.css("-moz-transform",t),e.css("-o-transform",t),e.css("-ms-transform",t),e.css("transform",t)},i=function(e){return"matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},s=function(e){var t=n(e);return{x:parseInt(t[4]),y:parseInt(t[5])}},a=function(e,t){var s=n(e);s[0]=s[3]=t;var a=i(s);o(e,a)},l=function(e,t,s){var a=n(e);a[4]=t,a[5]=s;var l=i(a);o(e,l)},r=function(e,t){var s=n(e),a=t*(Math.PI/180),l=-1*a;s[1]=a,s[2]=l;var r=i(s);o(e,r)};return{scale:a,translate:l,rotate:r,getTranslate:s}}(),i=function(o,i){var l=this;l.element=e(o),l.options=i,l.utils=new s,l.bubble=new a(l),e.extend(l,{bindEvents:function(){l.element.keydown(this.rawEvents.keydown),l.element.keyup(this.rawEvents.keyup),l.element.focus(this.rawEvents.focus),l.element.bind("paste",this.events.paste),l.element.mousedown(this.rawEvents.mouseClick),l.element.mouseup(this.rawEvents.mouseUp),l.element.mousemove(this.rawEvents.mouseMove),l.element.blur(this.rawEvents.blur),e("body").mouseup(function(e){e.target==e.currentTarget&&u.isSelecting&&this.rawEvents.mouseUp.call(l.element,e)})},setPlaceholder:function(t){if(/^\s*$/.test(e(this).text())){e(this).empty();var n=l.utils.html.addTag(e(this),"p").addClass("placeholder");n.append(e(this).attr("editor-placeholder")),l.utils.html.addTag(e(this),"p","undefined"!=typeof t.focus?t.focus:!1,!0)}else e(this).find(".placeholder").remove()},removePlaceholder:function(){e(this).find(".placeholder").remove()},preserveElementFocus:function(){var e=n.getSelection()?n.getSelection().anchorNode:t.activeElement;if(e){var o=e.parentNode,i=o!==u.focusedElement,s=this.children,a=0;o===this&&(o=e);for(var l=0;l<s.length;l++)if(o===s[l]){a=l;break}i&&(u.focusedElement=o,u.focusedElementIndex=a)}},prepare:function(){if(l.element.attr("editor-mode",l.options.mode),l.element.attr("editor-placeholder",l.options.placeholder),l.element.attr("contenteditable",!0),l.element.css("position","relative"),l.element.addClass("jquery-notebook editor"),l.setPlaceholder.call(l.element,{}),l.preserveElementFocus.call(l.element),i.autoFocus===!0){var e=l.element.find("p:not(.placeholder)");l.utils.cursor.set(l.element,0,e)}},rawEvents:{keydown:function(e){var t=this;u.command&&65===e.which&&setTimeout(function(){l.bubble.show()},50),l.utils.keyboard.isCommand(e,function(){u.command=!0},function(){u.command=!1}),l.utils.keyboard.isShift(e,function(){u.shift=!0},function(){u.shift=!1}),l.utils.keyboard.isModifier.call(this,e,function(t){u.command&&this.events.commands[t].call(this,e)}),u.shift?l.utils.keyboard.isArrow.call(this,e,function(){setTimeout(function(){var e=l.utils.selection.getText();""!==e?l.bubble.show():l.bubble.clear.call(t)},100)}):l.utils.keyboard.isArrow.call(this,e,function(){l.bubble.clear.call(t)}),13===e.which&&this.events.enterKey.call(this,e),27===e.which&&l.bubble.clear.call(this),86===e.which&&this.events.paste.call(this,e)},keyup:function(t){l.utils.keyboard.isCommand(t,function(){u.command=!1},function(){u.command=!0}),l.preserveElementFocus.call(this),l.removePlaceholder.call(this),/^\s*$/.test(e(this).text())&&(e(this).empty(),l.utils.html.addTag(e(this),"p",!0,!0))},focus:function(){u.command=!1,u.shift=!1},mouseClick:function(t){if(u.isSelecting=!0,2===t.button)return setTimeout(function(){l.bubble.show()},50),void t.preventDefault();if(e(this).find(".bubble:visible").length){var n=e(this).find(".bubble:visible"),o=n.offset().left,i=n.offset().top,s=n.width(),a=n.height();if(r>o&&o+s>r&&c>i&&i+a>c)return}},mouseUp:function(e){e.preventDefault();var t=this;u.isSelecting=!1,setTimeout(function(){var e=l.utils.selection.save();e.collapsed?l.bubble.clear.call(t):l.bubble.show()},50)},mouseMove:function(e){r=e.pageX,c=e.pageY},blur:function(){l.setPlaceholder.call(this,{focus:!1})}},events:{commands:{bold:function(e){e.preventDefault(),t.execCommand("bold",!1),l.bubble.update.call(this)},italic:function(e){e.preventDefault(),t.execCommand("italic",!1),l.bubble.update.call(this)},underline:function(e){e.preventDefault(),t.execCommand("underline",!1),l.bubble.update.call(this)},anchor:function(e){e.preventDefault();var t=l.utils.selection.save();l.bubble.showLinkInput.call(this,t)},createLink:function(e,n){l.utils.selection.restore(n),t.execCommand("createLink",!1,e.url),l.bubble.update.call(this)},removeLink:function(t,n){var o=e(l.utils.selection.getContainer(n)).closest("a");o.contents().first().unwrap()},h1:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h1")?t.execCommand("formatBlock",!1,"<p>"):t.execCommand("formatBlock",!1,"<h1>"),l.bubble.update.call(this)},h2:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h2")?t.execCommand("formatBlock",!1,"<p>"):t.execCommand("formatBlock",!1,"<h2>"),l.bubble.update.call(this)},ul:function(e){e.preventDefault(),t.execCommand("insertUnorderedList",!1),l.bubble.update.call(this)},ol:function(e){e.preventDefault(),t.execCommand("insertOrderedList",!1),l.bubble.update.call(this)},undo:function(e){e.preventDefault(),t.execCommand("undo",!1)}},enterKey:function(t){return"inline"===e(this).attr("editor-mode")?void t.preventDefault():void 0},paste:function(){var t=e(this);setTimeout(function(){t.find("*").each(function(){var t=e(this);e.each(this.attributes,function(){"class"===this.name&&t.hasClass("placeholder")||t.removeAttr(this.name)})})},100)}}});var r=("MacIntel"==n.navigator.platform,0),c=0,u={command:!1,shift:!1,isSelecting:!1};l.prepare(),l.bindEvents()},s=function(){e.extend(this,{keyboard:{isCommand:function(e,t,n){isMac&&e.metaKey||!isMac&&e.ctrlKey?t():n()},isShift:function(e,t,n){e.shiftKey?t():n()},isModifier:function(e,t){var n=e.which,o=modifiers[n];o&&t.call(this,o)},isEnter:function(e,t){13===e.which&&t()},isArrow:function(e,t){(e.which>=37||e.which<=40)&&t()}},html:{addTag:function(n,o,i,s){var a=e(t.createElement(o));return a.attr("contenteditable",Boolean(s)),a.append(" "),n.append(a),i&&(cache.focusedElement=n.children().last(),this.cursor.set(n,0,cache.focusedElement)),a},decode:function(t){return e("<div/>").html(t).text()}},cursor:{set:function(e,o,i){var s;if(t.createRange){s=t.createRange();var a=n.getSelection(),l=e.children().last(),r=l.html().length-1,c=i?i[0]:l[0],u="undefined"!=typeof o?o:r;s.setStart(c,u),s.collapse(!0),a.removeAllRanges(),a.addRange(s)}else s=t.body.createTextRange(),s.moveToElementText(i),s.collapse(!1),s.select()}},selection:{save:function(){if(n.getSelection){var e=n.getSelection();if(e.rangeCount>0)return e.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restore:function(e){if(e)if(n.getSelection){var o=n.getSelection();o.removeAllRanges(),o.addRange(e)}else t.selection&&e.select&&e.select()},getText:function(){var e="";return n.getSelection?e=n.getSelection().toString():t.getSelection?e=t.getSelection().toString():t.selection&&(e=t.selection.createRange().text),e},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getContainer:function(e){return n.getSelection&&e&&e.commonAncestorContainer?e.commonAncestorContainer:t.selection&&e&&e.parentElement?e.parentElement():null}},validation:{isUrl:function(e){return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(e)}}})},a=function(t){e.extend(this,{notebook:t,updatePos:function(t){var i=n.getSelection(),s=i.getRangeAt(0),a=s.getBoundingClientRect(),l=t.width(),r=t.height(),c=(this.notebook.element.offset().left,{x:a.left+a.width/2-l/2,y:a.top-r-8+e(document).scrollTop()});o.translate(t,c.x,c.y)},updateState:function(e,t){t.find("button").removeClass("active");var o=n.getSelection(),i=[];this.checkForFormatting(o.focusNode,i);for(var s={b:"bold",i:"italic",u:"underline",h1:"h1",h2:"h2",a:"anchor",ul:"ul",ol:"ol"},a=0;a<i.length;a++){var l=i[a];t.find("button."+s[l]).addClass("active")}},checkForFormatting:function(e,t){var n=["b","i","u","h1","h2","ol","ul","li","a"];("#text"===e.nodeName||-1!=n.indexOf(e.nodeName.toLowerCase()))&&("#text"!=e.nodeName&&t.push(e.nodeName.toLowerCase()),this.checkForFormatting(e.parentNode,t))},buildMenu:function(t){var n=this.notebook.utils.html.addTag(t,"ul",!1,!1);for(var o in this.notebook.options.modifiers){var i=this.notebook.utils.html.addTag(n,"li",!1,!1),s=this.notebook.utils.html.addTag(i,"button",!1,!1);s.attr("editor-command",this.notebook.options.modifiers[o]),s.addClass(this.notebook.options.modifiers[o])}t.find("button").click(function(t){t.preventDefault();var n=e(this).attr("editor-command");this.notebook.events.commands[n].call(this.notebook.element,t)});var a=this.notebook.utils.html.addTag(t,"div",!1,!1);a.addClass("link-area");var l=this.notebook.utils.html.addTag(a,"input",!1,!1);l.attr({type:"text"});var r=this.notebook.utils.html.addTag(a,"button",!1,!1);r.click(function(t){t.preventDefault();e(this).closest(".editor");e(this).closest(".link-area").hide(),e(this).closest(".bubble").find("ul").show()})},show:function(){var e=this.notebook.element.parent().find(".bubble");e.length||(e=this.notebook.utils.html.addTag(this.notebook.element.parent(),"div",!1,!1),e.addClass("jquery-notebook bubble"),this.buildMenu(e)),e.show(),this.updateState(this,e),e.hasClass("active")?e.removeClass("jump"):e.addClass("jump"),this.updatePos(e),e.addClass("active")},update:function(){var t=e(this).parent().find(".bubble");this.updateState(this,t)},clear:function(){var t=e(this).parent().find(".bubble");t.hasClass("active")&&(t.removeClass("active"),this.hideLinkInput.call(this),this.showButtons.call(this),setTimeout(function(){t.hasClass("active")||t.hide()},500))},hideButtons:function(){e(this).parent().find(".bubble").find("ul").hide()},showButtons:function(){e(this).parent().find(".bubble").find("ul").show()},showLinkInput:function(t){this.hideButtons.call(this);var n=this,o=e(this).parent().find(".bubble").find("input[type=text]"),i=o.closest(".jquery-notebook").find("button.anchor").hasClass("active");o.unbind("keydown"),o.keydown(function(o){var s=e(this);this.notebook.utils.keyboard.isEnter(o,function(){o.preventDefault();var e=s.val();this.notebook.utils.validation.isUrl(e)?(o.url=e,this.notebook.events.commands.createLink(o,t),this.clear.call(n)):""===e&&i&&(this.notebook.events.commands.removeLink(o,t),this.clear.call(n))})}),o.bind("paste",function(){var t=e(this);setTimeout(function(){var e=t.val();/http:\/\/https?:\/\//.test(e)&&(e=e.substring(7),t.val(e))},1)});var s="http://";if(i){var a=e(this.notebook.utils.selection.getContainer(t)).closest("a");s=a.prop("href")||s}e(this).parent().find(".link-area").show(),o.val(s).focus()},hideLinkInput:function(){e(this).parent().find(".bubble").find(".link-area").hide()}})};e.fn.notebook=function(t){return t=e.extend({},e.fn.notebook.defaults,t),this.each(function(){new i(this,t)})},e.fn.notebook.defaults={autoFocus:!1,placeholder:"Your text here...",mode:"multiline",modifiers:["bold","italic","underline","h1","h2","ol","ul","anchor"]}}(jQuery,document,window);